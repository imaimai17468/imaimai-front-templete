version: '3'

tasks:
  install:
    desc: Install dependencies using uv
    cmds:
      - uv sync --group dev

  dev:
    desc: Start development server
    cmds:
      - uv run uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload

  lint:
    desc: Run linting with ruff
    cmds:
      - uv run ruff check .

  lint:fix:
    desc: Run linting with ruff and auto-fix issues
    cmds:
      - uv run ruff check . --fix

  format:
    desc: Format code with ruff
    cmds:
      - uv run ruff format .

  format:check:
    desc: Check code formatting without making changes
    cmds:
      - uv run ruff format . --check

  test:
    desc: Run tests with pytest
    cmds:
      - uv run pytest

  typecheck:
    desc: Run type checking with mypy
    cmds:
      - uv run mypy src

  check:all:
    desc: Run all code quality checks (lint, format, typecheck)
    cmds:
      - task lint
      - task format:check
      - task typecheck
      - echo "âœ… ã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ"

  fix:all:
    desc: Auto-fix all possible issues (lint + format)
    cmds:
      - echo "ğŸ”§ ã‚³ãƒ¼ãƒ‰å“è³ªã®è‡ªå‹•ä¿®æ­£ã‚’é–‹å§‹..."
      - task lint:fix
      - task format
      - echo "âœ… è‡ªå‹•ä¿®æ­£ãŒå®Œäº†ã—ã¾ã—ãŸã€‚å‹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ - task typecheck"

  # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢é€£
  migrate:
    desc: Run auto migration (generate + upgrade)
    cmds:
      - uv run python -m src.script.auto_migrate

  migrate:generate:
    desc: Generate migration only (no upgrade)
    cmds:
      - uv run python -m src.script.auto_migrate --no-upgrade

  migrate:status:
    desc: Show migration status
    cmds:
      - uv run python -m src.script.auto_migrate --status

  migrate:upgrade:
    desc: Upgrade database to latest migration
    cmds:
      - uv run alembic upgrade head

  migrate:downgrade:
    desc: Safely rollback database by one migration (with file integrity check)
    cmds:
      - uv run python -m src.script.migration_safety --downgrade

  migrate:downgrade:force:
    desc: Force rollback database by one migration (skip integrity check)
    cmds:
      - echo "âš ï¸  å¼·åˆ¶å·»ãæˆ»ã—ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰"
      - uv run alembic downgrade -1

  migrate:check:
    desc: Check migration files integrity
    cmds:
      - uv run python -m src.script.migration_safety --check-only

  migrate:reset:
    desc: Reset database to base (remove all migrations)
    cmds:
      - echo "âš ï¸  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™"
      - uv run alembic downgrade base
      - echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆå®Œäº†ï¼ˆå…¨ã¦ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼‰"

  migrate:history:
    desc: Show migration history
    cmds:
      - uv run alembic history

  docker:build:
    desc: Build Docker image
    cmds:
      - docker compose -f docker/docker-compose.yml build

  docker:up:
    desc: Start Docker containers
    cmds:
      - docker compose -f docker/docker-compose.yml up

  docker:down:
    desc: Stop Docker containers
    cmds:
      - docker compose -f docker/docker-compose.yml down

  clean:
    desc: Clean up generated files
    cmds:
      - rm -rf .pytest_cache
      - rm -rf .mypy_cache
      - rm -rf .ruff_cache
      - rm -rf __pycache__
      - find . -name "*.pyc" -delete
      - find . -name "*.pyo" -delete